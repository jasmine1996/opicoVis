<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>D3 Bar Chart</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="http://d3js.org/d3.v4.min.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
        <style>
            body {
                font-family: 'Lato', sans-serif;
            }
            h3 {
                margin-bottom: 10px;
            }
            #timeChart {
                float: left;
            }
            .axis {
                font-size: 14px;
            }
            #xLabel, #yLabel {
                font-size: 18px;
            }
            .sidebar {
                float: right;
                width: 20%;
                height: 80vh;
                padding: 20px;
            }
            #timeUnitContainer {
                margin-bottom: 30px;
            }
            button {
                cursor: pointer;
                font-family: 'Lato', sans-serif;
                background: none;
                border: 0.1em solid #8b4eb7;
                color: #8b4eb7;
                font-size: 16px;
                border-radius: 5px;
            }
            .timeUnitButton {
                height: 40px;
                width: 80px;
                margin-right: 10px;
            }
            .typeButton {
                height: 40px;
                width: 80px;
                margin-right: 10px;
            }
            .selectedButton {
                color: white;
                background: #8b4eb7;
            }
            .emojiInputContainer {
                position: relative;
            }
            #enterEmojiBox {    
                height: 30px;
                width: 28px;
                float: left;
                border: 0.1rem solid #8b4eb7;
                border-radius: 5px 0px 0px 5px;
                font-size: 20px;
                padding: 0px 5px 2px 5px;
                margin-right: 10px;
            }
            #emojiKeyboard {
                display: none;
                width: 100%;
                height: 260px;
                overflow-y: scroll;
                overflow-x: hidden;
                border: 2px solid purple;
                position: absolute;
                border-radius: 5px;
                background: white;
                z-index: 100;
            }
            .emojiKey {
                text-align: center;
                float: left;
                width: 30px;
                font-size: 20px;
                margin: 5px;
                cursor: pointer;
            }
            #addEmojiButton {
                height: 35px;
                border-radius: 0px 5px 5px 0px;
                transform: translateX(-11px);
                background: #b892d3;
                color: white;
            }
            #currentEmojiList {
                list-style-type: square;
                width: 70px;
            }
            .emojiItem {
                position: relative;
                font-size: 20px;
                border: 0.1em solid;
                padding: 5px 10px 7px 8px;
                border-radius: 5px;
                margin-bottom: 5px;
            }
            .emojiDeleteButton {
                position: absolute;
                right: 0;
                top: 50%;
                border: none;
                font-size: 12px;
                transform: translateY(-50%);
                margin-left: 10px;
            }
        </style>
    </head>
    <body>
        <div id="timeChart"></div>
        <div class="sidebar">
            <h3>Select Time Unit</h3>
            <div id="timeUnitContainer">
                <button id="hourViewButton" class="timeUnitButton selectedButton">Hours</button>
                <button id="dayViewButton" class="timeUnitButton">Days</button>
                <button id="monthViewButton" class="timeUnitButton">Months</button>
            </div>
            <h3>Select Graph Type</h3>
            <div>
                <button id="stackedButton" class="typeButton selectedButton">Stacked</button>
                <button id="groupedButton" class="typeButton">Grouped</button>
            </div>
            <h3>Add Emojis</h3>
            <div class="emojiInputContainer">
                <form id="emojiInput">
                    <input id="enterEmojiBox" onclick="showKeyboard()" type="text" name="emoji" value="">
                </form>
                <button id="addEmojiButton" onclick="addEmoji()">➕</button>
                <div id="emojiKeyboard"></div>
            </div>
            <h3>Currently Showing</h3>
            <div id="currentEmojiList">
            </div>
        </div>
        <script>
            var containerWidth = window.innerWidth * 0.75,
                containerHeight = 600;
            var margin = {top: 50, right: 30, bottom: 20, left: 50},
                width = containerWidth - margin.left - margin.right,
                height = containerHeight - margin.top - margin.bottom;
            var svg;
            var xScale = d3.scaleBand();
            var yScale = d3.scaleLinear();

            var colors = ["#A64ECE", "#575EDA", "#61DAE4", "#6DEC84", "#C3F379", "#FBD75E", "#FD9762", "#FF6868", "#8A2F30", "#AE3D65", "#BF45A0", ];
            var currColorIndex = 0;
            var emojiColors = {};
            var dataCopy;
            var dataReady = false;
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const hours = [];
            for (let i = 0; i < 24; i++) {
                hours.push(i.toString());
            }
            const months = [];
            for (let i = 1; i <= 12; i++) {
                months.push(i.toString());
            }
            var currData = {
                hours: [],
                days: [],
                months: []
            };
            for (let i = 0; i < hours.length; i++) {
                currData.hours.push({hour: hours[i]});
            }
            for (let i = 0; i < days.length; i++) {
                currData.days.push({day: days[i]});
            }
            for (let i = 0; i < months.length; i++) {
                currData.months.push({month: months[i]});
            }
            var currEmojis = [];              // list of emojis currently displayed
            
            var currTimeUnit = "hour";
            var xDomain = eval(currTimeUnit+"s");

            var stacked = true;

            d3.json('time_vis_data.json', function(error, data) {
                dataCopy = data;
                dataReady = true;

                svg = d3.select("#timeChart")
                    .append("svg")
                    .attr("width", containerWidth)
                    .attr("height", containerHeight);

                // calculates the offset in y for each stacked bar
                var dataset = d3.stack().keys(currEmojis)(currData[currTimeUnit+"s"]);

                var x = xScale.domain(xDomain)
                    .rangeRound([margin.left, width])
                    .padding(0.1)
                    .align(0.1);

                var y = yScale.domain([0, d3.max(dataset, function(d) {  let max = d3.max(d, function(d) { return d[1]; }); return max; })])
                    .range([height, margin.top]);

                // x-axis
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + (height) + ")")
                    .call(d3.axisBottom(x));

                // y-axis
                svg.append("g")
                    .attr("class", "y axis")
                    .attr("transform", "translate(" + margin.left + ", 0)")
                    .call(d3.axisLeft(y));

                svg.append("text")
                    .attr("id", "xLabel")         
                    .attr("transform",
                            "translate(" + (width/2 + margin.left) + " ," + 
                                        (height + margin.top) + ")")
                    .style("text-anchor", "middle")
                    .text(currTimeUnit.charAt(0).toUpperCase() + currTimeUnit.slice(1));
                
                svg.append("text")  
                    .attr("id", "yLabel")            
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0)
                    .attr("x", 0 - (height/2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Total Count");

                // group for drinks
                svg.selectAll("g.stack")
                    .data(dataset)
                    .enter()
                    .append("g")
                    .attr("class", "stack")
                    .attr("fill", function(d, i) { return emojiColors[d.key]; })
                    .selectAll("rect")
                    .data((d) => addIndexToData(d))
                    .enter()
                    .append('rect')
                    .attr("x", (d, i) => getBarX(d, x))
                    .attr("y", (d, i) => getBarY(d, y))
                    .attr("width", getWidth(x))
                    .attr("height", (d, i) => y(d[0]) - y(d[1]));

                createKeyboard();
            });

            function addEmojiToDisplay(emoji) {
                currEmojis.push(emoji);              // list of emojis currently displayed
                let emojiData = dataCopy[emoji];
                for (let i = 0; i < hours.length; i++) {
                    currData.hours[i][emoji] = emojiData.hours[i].frequency;
                }
                for (let i = 0; i < days.length; i++) {
                    currData.days[i][emoji] = emojiData.days[i].frequency;
                }
                for (let i = 0; i < months.length; i++) {
                    currData.months[i][emoji] = emojiData.months[i].frequency;
                }
                emojiColors[emoji] = colors[currColorIndex];
                currColorIndex = (currColorIndex + 1) % colors.length;
            }

            function removeEmojiToDisplay(emoji) {
                let index = currEmojis.indexOf(emoji);              // list of emojis currently displayed
                currEmojis.splice(index, 1);
                for (let i = 0; i < hours.length; i++) {
                    delete currData.hours[i][emoji];
                }
                for (let i = 0; i < days.length; i++) {
                    delete currData.days[i][emoji];
                }
                for (let i = 0; i < months.length; i++) {
                    delete currData.months[i][emoji];
                }
                delete emojiColors[emoji];
            }

            function updateChart() {
                var dataset = d3.stack().keys(currEmojis)(currData[currTimeUnit+"s"]);
                // animate changes in axies
                var x = xScale.domain(xDomain)
                    .rangeRound([margin.left, width])
                    .padding(0.1)
                    .align(0.1);
                var y = yScale.domain([0, d3.max(dataset, function(d) {  let max = d3.max(d, function(d) { return stacked? d[1] : d[1] - d[0]; }); return max; })])
                    .range([height, margin.top]);

                var t = d3.transition()
                    .duration(500);
                svg.select(".x")
                    .transition(t)
                    .call(d3.axisBottom(x));
                svg.select(".y")
                    .transition(t)
                    .call(d3.axisLeft(y));

                svg.select("#xLabel")
                    .text(currTimeUnit.charAt(0).toUpperCase() + currTimeUnit.slice(1));

                // update bars
                var stacks = svg.selectAll("g.stack")
                    .data(dataset);
                // remove removed emoji bars
                stacks.exit().remove();
                // recolor bars that are not removed
                stacks.attr("fill", function(d, i) { return emojiColors[d.key]; });
                // add new emoji bars
                stacks.enter()
                    .append("g")
                    .attr("class", "stack")
                    .attr("fill", function(d, i) { return emojiColors[d.key]; })
                    .selectAll("rect")
                    .data((d) => addIndexToData(d))
                    .enter()
                    .append('rect')
                    .attr("x", (d, i) => getBarX(d, x))
                    .attr("y", (d, i) => getBarY(d, y))
                    .attr("width", getWidth(x))
                    .attr("height", 0);
                
                var emojiBars = svg.selectAll("g.stack").selectAll("rect")
                    .data((d) => addIndexToData(d))
                emojiBars.exit().remove();
                emojiBars.enter()
                    .append('rect')
                    .attr("x", (d, i) => getBarX(d, x))
                    .attr("y", (d, i) => getBarY(d, y))
                    .attr("width", x.bandwidth())
                    .attr("height", 0);
                svg.selectAll("g.stack").selectAll("rect")
                    .transition(t)
                    .attr("x", (d, i) => getBarX(d, x))
                    .attr("y", (d, i) => getBarY(d, y))
                    .attr("width", getWidth(x))
                    .attr("height", (d, i) => y(d[0]) - y(d[1]));
            }

            function getBarY(d, y) {
                if (stacked)
                    return y(d[1]);
                else
                    return y(d[1]) + (height - y(d[0]));
            }
            function getBarX(d, x) {
                if (stacked)
                    return x(d.data[currTimeUnit]);
                else {
                    return x(d.data[currTimeUnit]) + getWidth(x) * d.index;
                }
            }
            function getWidth(x) {
                if (stacked)
                    return x.bandwidth();
                else {
                    return x.bandwidth() / currEmojis.length;
                }
            }
            function addIndexToData(d) {
                let newD = d;
                for (let i = 0; i < newD.length; i++) {
                    newD[i].index = d.index;
                }
                return newD;
            }

            let viewButtons = document.getElementsByClassName("timeUnitButton");
            for (let i = 0; i < viewButtons.length; i++) {
                viewButtons[i].addEventListener('click', function() {
                    switchView(i);
                })
            }
            let typeButtons = document.getElementsByClassName("typeButton");
            for (let i = 0; i < typeButtons.length; i++) {
                typeButtons[i].addEventListener('click', function() {
                    switchType(i);
                })
            }

            function switchType(code) {
                if (!dataReady) return;
                if (code == 0 && !stacked) {
                    stacked = true;
                    document.getElementById("stackedButton").classList.add("selectedButton");
                    document.getElementById("groupedButton").classList.remove("selectedButton");
                    updateChart();
                }
                else if (code == 1 && stacked) {
                    stacked = false;
                    document.getElementById("groupedButton").classList.add("selectedButton");
                    document.getElementById("stackedButton").classList.remove("selectedButton");
                    updateChart();
                }
            }

            function switchView(code) {
                if (!dataReady) return;
                if (code == 0 && currTimeUnit !== "hour") {    // hour
                    currTimeUnit = "hour";
                }
                else if (code == 1 && currTimeUnit !== "day") {    // day
                    currTimeUnit = "day";
                }
                else if (code == 2 && currTimeUnit !== "month") {     // month
                    currTimeUnit = "month";
                }
                let buttons = document.getElementsByClassName("timeUnitButton");
                for (let i = 0; i < buttons.length; i++) {
                    if (i == code)
                        buttons[i].classList.add("selectedButton");
                    else
                        buttons[i].classList.remove("selectedButton");
                }
                xDomain = eval(currTimeUnit+"s");
                updateChart();
            }

            function addEmoji(newEmoji) {
                //let newEmoji = document.getElementById('emojiInput').elements[0].value;
                if (newEmoji == "") return;
                addEmojiToDisplay(newEmoji);
                document.getElementById('emojiInput').elements[0].value = "";

                let li = document.createElement("DIV");
                li.innerHTML = newEmoji;
                li.setAttribute("id", newEmoji+"Item");
                li.setAttribute("class", "emojiItem");
                li.style.color = emojiColors[newEmoji];
                li.style.background = emojiColors[newEmoji]+"66";
                let button = document.createElement("BUTTON");
                button.innerHTML = "✖️";
                button.setAttribute("class", "emojiDeleteButton");
                button.addEventListener('click', function() {
                    removeEmoji(newEmoji);
                });
                li.append(button);
                document.getElementById('currentEmojiList').prepend(li);

                document.getElementById('emojiKeyboard').style.display = "none";

                updateChart();
            }
            function removeEmoji(emoji) {
                //let emoji = document.getElementById('emojiInput').elements[0].value;
                if (emoji == "") return;
                removeEmojiToDisplay(emoji);
                document.getElementById(emoji+"Item").remove();

                updateChart();
            }

            function createKeyboard() {
                let emojiKeys = Object.keys(dataCopy);
                for (let i = 0; i < 300; i++) {
                    let li = document.createElement("DIV");
                    li.innerHTML = emojiKeys[i];
                    li.setAttribute("id", emojiKeys[i]+"Key");
                    li.setAttribute("class", "emojiKey");
                    li.addEventListener('click', function() {
                        addEmoji(emojiKeys[i]);
                    })
                    document.getElementById('emojiKeyboard').append(li);
                }
            }

            function showKeyboard() {
                document.getElementById('emojiKeyboard').style.display = "block";
            }
        </script>
    </body>
</html>

